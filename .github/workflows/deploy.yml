name: Deploy Hubbly API

on:
  push:
    branches: [ master, main ]

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: 'Hubbly.Api/Hubbly.Api.csproj'
  PUBLISH_PATH: './publish'
  MAX_BACKUPS: 3

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore ${{ env.PROJECT_PATH }}

      - name: Build
        run: dotnet build ${{ env.PROJECT_PATH }} --configuration Release --no-restore

      - name: Run tests
        run: dotnet test --no-build --configuration Release --verbosity normal

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore dependencies
      run: dotnet restore ${{ env.PROJECT_PATH }}
    
    - name: Build
      run: dotnet build ${{ env.PROJECT_PATH }} --configuration Release --no-restore
    
    - name: Publish project
      run: |
        echo "üì¶ Publishing project..."
        dotnet publish ${{ env.PROJECT_PATH }} \
          --configuration Release \
          --output ${{ env.PUBLISH_PATH }} \
          --no-build \
          --no-restore
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ critical files
        echo "üîç Verifying published files..."
        
        if [ ! -f "${{ env.PUBLISH_PATH }}/wwwroot/three_scene.html" ]; then
          echo "‚ùå three_scene.html MISSING!"
          exit 1
        else
          echo "‚úÖ three_scene.html is present"
        fi
        
        if [ ! -f "${{ env.PUBLISH_PATH }}/appsettings.Production.json" ]; then
          echo "‚ö†Ô∏è appsettings.Production.json is missing (will be preserved from server)"
        fi
    
    - name: Create deployment package
      run: |
        echo "üì¶ Creating deployment package..."
        cd ${{ env.PUBLISH_PATH }}
        
        # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—É—é —Å—É–º–º—É
        find . -type f -exec md5sum {} \; > checksums.txt
        
        # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ —Å –º–µ—Ç–∫–æ–π –≤—Ä–µ–º–µ–Ω–∏
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        tar -czf ../hubbly_${TIMESTAMP}.tar.gz .
        cd ..
        
        echo "‚úÖ Package created: hubbly_${TIMESTAMP}.tar.gz"
        echo "TIMESTAMP=${TIMESTAMP}" >> $GITHUB_ENV
        echo "PACKAGE_SIZE=$(du -h hubbly_${TIMESTAMP}.tar.gz | cut -f1)" >> $GITHUB_ENV
    
    - name: Copy to server
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        port: ${{ secrets.SERVER_PORT }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        source: "hubbly_${{ env.TIMESTAMP }}.tar.gz"
        target: "/tmp"
        strip_components: 0
    
    - name: Deploy on server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        port: ${{ secrets.SERVER_PORT }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          set -e
          
          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
          TIMESTAMP="${{ env.TIMESTAMP }}"
          NEW_VERSION="/opt/hubbly-${TIMESTAMP}"
          CURRENT_VERSION="/opt/hubbly"
          BACKUP_VERSION="/opt/hubbly-backup"
          MAX_BACKUPS=${{ env.MAX_BACKUPS }}
          
          # –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
          log() {
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
          }
          
          # –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π
          cleanup_old_versions() {
            log "üßπ Cleaning up old versions..."
            cd /opt
            ls -dt hubbly-* 2>/dev/null | tail -n +$((MAX_BACKUPS + 1)) | xargs -r rm -rf
          }
          
          # –§—É–Ω–∫—Ü–∏—è rollback
          rollback() {
            log "‚Ü©Ô∏è Rolling back deployment..."
            systemctl stop hubbly || true
            rm -rf ${CURRENT_VERSION}
            if [ -d "${BACKUP_VERSION}" ]; then
              mv ${BACKUP_VERSION} ${CURRENT_VERSION}
              systemctl start hubbly
              log "‚úÖ Rollback completed"
            else
              log "‚ùå No backup available for rollback"
            fi
            exit 1
          }
          
          log "üöÄ Starting deployment (version: ${TIMESTAMP})..."
          log "üì¶ Package size: ${{ env.PACKAGE_SIZE }}"
          
          # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞
          log "üíæ Checking disk space..."
          FREE_SPACE=$(df /opt | awk 'NR==2 {print $4}')
          if [ $FREE_SPACE -lt 1048576 ]; then  # 1GB –≤ KB
            log "‚ùå Insufficient disk space: $(($FREE_SPACE/1024))MB available"
            exit 1
          fi
          log "‚úÖ Disk space OK: $(($FREE_SPACE/1024))MB available"
          
          # 2. –†–∞—Å–ø–∞–∫–æ–≤–∫–∞
          log "üì¶ Extracting new version..."
          rm -rf ${NEW_VERSION}
          mkdir -p ${NEW_VERSION}
          tar -xzf /tmp/hubbly_${TIMESTAMP}.tar.gz -C ${NEW_VERSION}
          rm /tmp/hubbly_${TIMESTAMP}.tar.gz
          
          # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
          log "üîç Verifying package integrity..."
          cd ${NEW_VERSION}
          md5sum -c checksums.txt > /dev/null 2>&1
          if [ $? -eq 0 ]; then
            log "‚úÖ Package integrity verified"
          else
            log "‚ùå Package integrity check failed!"
            exit 1
          fi
          rm checksums.txt
          
          # 4. –°–û–•–†–ê–ù–Ø–ï–ú –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ–∞–π–ª—ã
          log "üíæ Preserving user-uploaded files..."
          if [ -d "${CURRENT_VERSION}/wwwroot/avatars" ]; then
            mkdir -p ${NEW_VERSION}/wwwroot
            cp -r ${CURRENT_VERSION}/wwwroot/avatars ${NEW_VERSION}/wwwroot/ 2>/dev/null && \
              log "‚úÖ Avatars preserved" || log "‚ö†Ô∏è No avatars to preserve"
            cp -r ${CURRENT_VERSION}/wwwroot/animations ${NEW_VERSION}/wwwroot/ 2>/dev/null && \
              log "‚úÖ Animations preserved" || log "‚ö†Ô∏è No animations to preserve"
          fi
          
          # 5. –°–û–•–†–ê–ù–Ø–ï–ú –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
          log "üíæ Preserving configuration..."
          if [ -f "${CURRENT_VERSION}/appsettings.Production.json" ]; then
            cp ${CURRENT_VERSION}/appsettings.Production.json ${NEW_VERSION}/ 2>/dev/null && \
              log "‚úÖ Configuration preserved" || log "‚ö†Ô∏è No config to preserve"
          fi
          
          # 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ critical files
          log "üîç Verifying critical files..."
          if [ ! -f "${NEW_VERSION}/wwwroot/three_scene.html" ]; then
            log "‚ùå three_scene.html missing in new version!"
            exit 1
          fi
          log "‚úÖ Critical files OK"
          
          # 7. –ú–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏ (blue-green)
          log "üîÑ Switching versions..."
          rm -rf ${BACKUP_VERSION}
          if [ -d "${CURRENT_VERSION}" ]; then
            mv ${CURRENT_VERSION} ${BACKUP_VERSION}
            log "‚úÖ Current version backed up"
          fi
          mv ${NEW_VERSION} ${CURRENT_VERSION}
          
          # 8. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å (–º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!)
          log "üîÑ Restarting service..."
          systemctl restart hubbly
          
          # 9. –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
          log "‚è≥ Waiting for service to start (15s)..."
          sleep 15
          
          # 10. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞
          log "üìä Checking service status..."
          if systemctl is-active --quiet hubbly; then
            log "‚úÖ Service is running"
          else
            log "‚ùå Service failed to start"
            systemctl status hubbly --no-pager
            rollback
          fi
          
          # 11. –ü—Ä–æ–≤–µ—Ä—è–µ–º health endpoint
          log "üè• Checking health endpoint..."
          for i in {1..5}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/health/live)
            if [ "${HTTP_CODE}" = "200" ]; then
              log "‚úÖ Health check passed (HTTP ${HTTP_CODE})"
              break
            else
              log "‚è≥ Health check attempt ${i}/5 returned ${HTTP_CODE}"
              sleep 5
            fi
          done
          
          if [ "${HTTP_CODE}" != "200" ]; then
            log "‚ùå Health check failed after 5 attempts!"
            rollback
          fi
          
          # 12. –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏
          cleanup_old_versions
          
          # 13. –§–∏–Ω–∞–ª—å–Ω—ã–π —É—Å–ø–µ—Ö
          log "‚úÖ‚úÖ‚úÖ Deployment completed successfully!"
          log "üìù Version: ${TIMESTAMP}"
          log "üìù Released by: ${{ github.actor }}"
          log "üìù Commit: ${{ github.sha }}"