name: Deploy Hubbly API

on:
  push:
    branches: [ master ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '9.0.x'
    
    - name: Restore dependencies
      run: dotnet restore Hubbly.Backend.sln
    
    - name: Build
      run: dotnet build Hubbly.Backend.sln --configuration Release --no-restore
    
    - name: Run tests
      run: |
        dotnet test Hubbly.Application.Tests/Hubbly.Application.Tests.csproj \
          --configuration Release \
          --no-build \
          --collect:"XPlat Code Coverage" \
          --logger "trx;LogFileName=test_results.trx"
      continue-on-error: false
    
    - name: Publish project
      run: |
        dotnet publish Hubbly.Api/Hubbly.Api.csproj \
          --configuration Release \
          --output ./publish \
          --no-build \
          --no-restore
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ three_scene.html
        if [ -f "./publish/wwwroot/three_scene.html" ]; then
          echo "‚úÖ three_scene.html is present"
        else
          echo "‚ùå three_scene.html MISSING!"
          exit 1
        fi
    
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v2
      
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        file: deployment/docker/Dockerfile.api
        push: true
        tags: garloon/hubbly-api:latest
        cache-from: type=registry,ref=garloon/hubbly-api:latest
        cache-to: type=inline

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
    - name: Checkout deployment files
      uses: actions/checkout@v3
      with:
        sparse-checkout: |
          deployment/
        sparse-checkout-cone-mode: true
    
    - name: Copy deployment files to server
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        port: ${{ secrets.SERVER_PORT }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        source: "deployment/*"
        target: "/opt/hubbly/"
        strip_components: 1
    
    - name: Deploy on server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        port: ${{ secrets.SERVER_PORT }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          set -e
          
          echo "üöÄ Starting deployment..."
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é deployments
          cd /opt/hubbly
          
          # –ê–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è –≤ Docker Hub (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã)
          echo "üîê Logging in to Docker Hub..."
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
          echo "üõë Stopping old containers..."
          docker-compose down 2>/dev/null || true
          
          # –ü—É–ª–ª–∏–º —Å–≤–µ–∂–∏–π –æ–±—Ä–∞–∑
          echo "üì• Pulling latest image..."
          docker-compose pull
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
          echo "üöÄ Starting containers..."
          docker-compose up -d
          
          # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
          sleep 10
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
          echo "üìä Container status:"
          docker-compose ps
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ API
          echo "üìã API logs (last 50 lines):"
          docker logs hubbly-api --tail 50
          
          echo "‚úÖ Deployment completed successfully!"