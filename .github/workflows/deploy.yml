name: Deploy Hubbly API

on:
  push:
    branches: [ master, main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'
    
    - name: Restore dependencies
      run: dotnet restore Hubbly.Api/Hubbly.Api.csproj
    
    - name: Build
      run: dotnet build Hubbly.Api/Hubbly.Api.csproj --configuration Release --no-restore
    
    - name: Publish project
      run: |
        # –ü—É–±–ª–∏–∫—É–µ–º –ø—Ä–æ–µ–∫—Ç
        dotnet publish Hubbly.Api/Hubbly.Api.csproj \
          --configuration Release \
          --output ./publish \
          --no-build \
          --no-restore
        
        # ‚úÖ –Ø–í–ù–û –∫–æ–ø–∏—Ä—É–µ–º wwwroot (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
        if [ -d "Hubbly.Api/wwwroot" ]; then
          echo "Copying wwwroot files..."
          mkdir -p ./publish/wwwroot
          cp -r Hubbly.Api/wwwroot/* ./publish/wwwroot/
          echo "‚úÖ wwwroot copied"
        else
          echo "‚ö†Ô∏è wwwroot folder not found"
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ three_scene.html –Ω–∞ –º–µ—Å—Ç–µ
        if [ -f "./publish/wwwroot/three_scene.html" ]; then
          echo "‚úÖ three_scene.html is present"
        else
          echo "‚ùå three_scene.html MISSING!"
          exit 1
        fi
    
    - name: Create tar archive
      run: |
        cd publish
        tar -czf ../publish.tar.gz .
        cd ..
    
    - name: Copy to server
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        port: ${{ secrets.SERVER_PORT }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        source: "publish.tar.gz"
        target: "/tmp"  # ‚úÖ –ö–ª–∞–¥—ë–º –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É, –∞ –Ω–µ –≤ /opt
    
    - name: Deploy on server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        port: ${{ secrets.SERVER_PORT }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          set -e  # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
          
          echo "üöÄ Starting deployment..."
          
          # 1. –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
          echo "üì¶ Extracting files..."
          rm -rf /opt/hubbly-publish-new
          mkdir -p /opt/hubbly-publish-new
          tar -xzf /tmp/publish.tar.gz -C /opt/hubbly-publish-new
          rm /tmp/publish.tar.gz
          
          # 2. –°–û–•–†–ê–ù–Ø–ï–ú —Å—Ç–∞—Ä—ã–π wwwroot (—Ñ–∞–π–ª—ã, –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É)
          echo "üíæ Preserving existing wwwroot files..."
          if [ -d "/opt/hubbly-publish/wwwroot/avatars" ]; then
            mkdir -p /opt/hubbly-publish-new/wwwroot
            cp -r /opt/hubbly-publish/wwwroot/avatars /opt/hubbly-publish-new/wwwroot/ 2>/dev/null || true
            cp -r /opt/hubbly-publish/wwwroot/animations /opt/hubbly-publish-new/wwwroot/ 2>/dev/null || true
          fi
          
          # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ three_scene.html
          if [ ! -f "/opt/hubbly-publish-new/wwwroot/three_scene.html" ]; then
            echo "‚ùå ERROR: three_scene.html missing in new version!"
            exit 1
          fi
          
          # 4. –ú–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏ (blue-green deployment)
          echo "üîÑ Switching versions..."
          rm -rf /opt/hubbly-publish-old
          mv /opt/hubbly-publish /opt/hubbly-publish-old 2>/dev/null || true
          mv /opt/hubbly-publish-new /opt/hubbly-publish
          
          # 5. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å
          echo "üîÑ Restarting service..."
          systemctl restart hubbly
          sleep 5
          
          # 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
          echo "üìä Service status:"
          systemctl status hubbly --no-pager
          
          # 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª –æ–±–Ω–æ–≤–∏–ª—Å—è
          echo "üîç Verifying three_scene.html..."
          grep -q "statusBar" /opt/hubbly-publish/wwwroot/three_scene.html && (
            echo "‚ùå ERROR: statusBar still present!"
            exit 1
          ) || echo "‚úÖ three_scene.html is clean"
          
          echo "‚úÖ Deployment completed successfully!"