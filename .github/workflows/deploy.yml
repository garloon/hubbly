name: Deploy Hubbly API

on:
  push:
    branches: [ master, main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'
    
    - name: Restore dependencies
      run: dotnet restore Hubbly.Backend.sln
    
    - name: Build
      run: dotnet build Hubbly.Backend.sln --configuration Release --no-restore
    
    - name: Run tests
      run: |
        dotnet test Hubbly.Application.Tests/Hubbly.Application.Tests.csproj \
          --configuration Release \
          --no-build \
          --collect:"XPlat Code Coverage" \
          --logger "trx;LogFileName=test_results.trx"
      continue-on-error: false
    
    - name: Publish project
      run: |
        dotnet publish Hubbly.Api/Hubbly.Api.csproj \
          --configuration Release \
          --output ./publish \
          --no-build \
          --no-restore
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ three_scene.html
        if [ -f "./publish/wwwroot/three_scene.html" ]; then
          echo "âœ… three_scene.html is present"
        else
          echo "âŒ three_scene.html MISSING!"
          exit 1
        fi
    
    - name: Create tar archive
      run: |
        cd publish
        tar -czf ../publish.tar.gz .
        cd ..
    
    - name: Copy to server
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        port: ${{ secrets.SERVER_PORT }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        source: "publish.tar.gz"
        target: "/tmp"
    
    - name: Deploy on server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        port: ${{ secrets.SERVER_PORT }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          set -e
          
          echo "ğŸš€ Starting deployment..."
          
          # 1. Ğ Ğ°ÑĞ¿Ğ°ĞºĞ¾Ğ²Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²ÑƒÑ Ğ²ĞµÑ€ÑĞ¸Ñ
          echo "ğŸ“¦ Extracting files..."
          rm -rf /opt/hubbly-publish-new
          mkdir -p /opt/hubbly-publish-new
          tar -xzf /tmp/publish.tar.gz -C /opt/hubbly-publish-new
          rm /tmp/publish.tar.gz
          
          # 2. âœ… ĞœĞĞ”Ğ•Ğ›Ğ˜ ĞœĞ•ĞĞ¯Ğ®Ğ¢Ğ¡Ğ¯ ĞĞ’Ğ¢ĞĞœĞĞ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜!
          #    ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ¸Ğ· Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ
          echo "ğŸ†• Using new avatar models from repository"
          
          # 3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ three_scene.html
          if [ ! -f "/opt/hubbly-publish-new/wwwroot/three_scene.html" ]; then
            echo "âŒ ERROR: three_scene.html missing in new version!"
            exit 1
          fi
          
          # 4. Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ±ÑĞºĞ°Ğ¿ ÑÑ‚Ğ°Ñ€Ñ‹Ñ… Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹ (Ğ½Ğ° Ğ²ÑÑĞºĞ¸Ğ¹ ÑĞ»ÑƒÑ‡Ğ°Ğ¹)
          echo "ğŸ’¾ Creating backup of old models..."
          mkdir -p /opt/hubbly-backups/$(date +%Y%m%d_%H%M%S)
          if [ -d "/opt/hubbly-publish/wwwroot/avatars" ]; then
            cp -r /opt/hubbly-publish/wwwroot/avatars /opt/hubbly-backups/$(date +%Y%m%d_%H%M%S)/
          fi
          
          # 5. ĞœĞµĞ½ÑĞµĞ¼ Ğ¼ĞµÑÑ‚Ğ°Ğ¼Ğ¸
          echo "ğŸ”„ Switching versions..."
          rm -rf /opt/hubbly-publish-old
          mv /opt/hubbly-publish /opt/hubbly-publish-old 2>/dev/null || true
          mv /opt/hubbly-publish-new /opt/hubbly-publish
          
          # 6. ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑĞµÑ€Ğ²Ğ¸Ñ
          echo "ğŸ”„ Restarting service..."
          systemctl restart hubbly
          sleep 5
          
          # 7. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ
          echo "ğŸ“Š Service status:"
          systemctl status hubbly --no-pager
          
          echo "âœ… Deployment completed successfully!"
          echo "ğŸ“ New models deployed to /opt/hubbly-publish/wwwroot/avatars/"